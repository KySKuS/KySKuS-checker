#!/bin/bash

CONFIG="/etc/KySKuS-checker.conf"
SERVICE="check"

if [[ ! -f "$CONFIG" ]]; then
    cat > "$CONFIG" << INIT
INTERVAL=60
FILES=/etc/passwd,/etc/group,/etc/sudoers
LOG_ENABLED=true
AUTO_START=true
INIT
    chmod 600 "$CONFIG"
    chown root:root "$CONFIG"
fi

show_help() {
    echo "Usage: KySKuS-checker [get|set] <option> [value]"
    echo "Options:"
    echo "  interval    - set check interval (seconds)"
    echo "  files       - set files to monitor (comma-separated, NO spaces)"
    echo "  log         - enable/disable logging (true/false)"
    echo "  auto_start  - enable/disable autostart (true/false)"
    echo "  all         - show all settings"
}

apply_autostart() {
    if [[ "$1" == "true" ]]; then
        systemctl enable --quiet "$SERVICE"
        echo "✓ Autostart enabled"
    else
        systemctl disable --quiet "$SERVICE"
        echo "✓ Autostart disabled"
    fi
}

case "$1" in
    get)
        cat "$CONFIG"
        ;;
    set)
        if [[ -z "$2" || -z "$3" ]]; then show_help; exit 1; fi
        KEY=$(echo "$2" | tr '[:lower:]' '[:upper:]')
        case "$KEY" in
            INTERVAL)
                if [[ "$3" =~ ^[0-9]+$ && "$3" -gt 0 ]]; then
                    sed -i "s/^INTERVAL=.*/INTERVAL=$3/" "$CONFIG"
                else echo "Error: interval must be a positive number"; exit 1; fi
                ;;
            FILES)
                if [[ "$3" == *,* && "$3" != *\ * ]]; then
                    sed -i "s|^FILES=.*|FILES=$3|" "$CONFIG"
                else echo "Error: files must be comma-separated WITHOUT spaces"; exit 1; fi
                ;;
            LOG)
                if [[ "$3" == "true" || "$3" == "false" ]]; then
                    sed -i "s|^LOG_ENABLED=.*|LOG_ENABLED=$3|" "$CONFIG"
                else echo "Error: log must be 'true' or 'false'"; exit 1; fi
                ;;
            AUTO_START)
                if [[ "$3" == "true" || "$3" == "false" ]]; then
                    sed -i "s|^AUTO_START=.*|AUTO_START=$3|" "$CONFIG"
                    apply_autostart "$3"
                else echo "Error: auto_start must be 'true' or 'false'"; exit 1; fi
                ;;
            *) echo "Unknown option: $2"; show_help; exit 1; ;;
        esac

        if [[ "$KEY" != "AUTO_START" ]]; then
            systemctl is-active --quiet "$SERVICE" && systemctl restart "$SERVICE"
            echo "✓ Updated and restarted service '$SERVICE'"
        fi
        ;;
    *)
        show_help
        exit 1
        ;;
esac
